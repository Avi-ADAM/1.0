# זרימת עבודה מלאה - מערכת אישור חלוקות

## סקירה כללית

המערכת מטפלת בתהליך מלא של אישור חלוקות, מההצבעה הראשונית ועד לאישור סופי של העברת הכסף.

## שלבי התהליך

### שלב 1: הצבעה על החלוקה
**קומפוננטה**: `halukaask.svelte`

1. משתמש רואה הצעת חלוקה
2. משתמש מצביע בעד/נגד
3. המערכת מעדכנת את מספר המצביעים
4. אם כל המשתמשים הצביעו בעד → עובר לשלב 2

### שלב 2: אישור החלוקה
**API**: `/api/approveHaluka`

1. המערכת מעדכנת את ה-tosplit כ-finished
2. מעדכנת את כל ה-sales כ-splited
3. מעדכנת את כל ה-halukot כ-ushar (מאושר)
4. מחשבת מי מקבל כסף ומי נותן
5. שולחת התראות מותאמות אישית

### שלב 3: התראות מותאמות
**שירות**: `HalukaNotificationService`

#### למקבל כסף:
```
🎉 מזל טוב! קיבלת 100 ש״ח

החלוקה אושרה והסכום של 100 ש״ח נוסף ליתרה שלך! 💰

כעת עליך להיכנס לעמוד הלב כדי לתאם את פרטי קבלת הכסף 
ולאשר שקיבלת אותו.

[כניסה לעמוד הלב]
```

#### לנותן כסף:
```
📋 חלוקה אושרה - 100 ש״ח

החלוקה אושרה. עליך להעביר 100 ש״ח. תודה על שיתוף הפעולה 🤝

כעת עליך להיכנס לעמוד הלב כדי לתאום את פרטי ההעברה 
ולאשר שהעברת את הכסף.

[כניסה לעמוד הלב]
```

### שלב 4: תיאום ההעברה
**קומפוננטה**: `didiget.svelte` בעמוד `/lev`

1. משתמש לוחץ על הקישור בהתראה
2. נכנס לעמוד `/lev`
3. רואה את הקומפוננטה `didiget` עם פרטי החלוקה
4. יכול לפתוח צ'אט עם המשתמש השני
5. מתאם איך להעביר את הכסף (העברה בנקאית, מזומן, וכו')

### שלב 5: אישור סופי
**קומפוננטה**: `didiget.svelte`

#### למקבל:
1. לוחץ על כפתור "אישור קבלת הכסף"
2. המערכת מעדכנת את ה-haluka כ-confirmed
3. אם כל ה-halukot בקבוצה אושרו → מעדכן את יתרות המשתמשים

#### לנותן:
1. לוחץ על כפתור "אישור שהעברתי את הכסף"
2. המערכת מעדכנת את ה-haluka כ-senderconf
3. ממתין לאישור המקבל

## דיאגרמת זרימה מפורטת

```
┌─────────────────────────────────────────────────────────────┐
│                    שלב 1: הצבעה                              │
│                                                              │
│  halukaask.svelte                                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ משתמש A מצביע בעד                                    │  │
│  │ משתמש B מצביע בעד                                    │  │
│  │ ✅ כל המשתמשים הצביעו בעד                           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  שלב 2: אישור החלוקה                         │
│                                                              │
│  /api/approveHaluka                                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 1. updateTosplit (finished: true)                    │  │
│  │ 2. updateSale (splited: true) × N                    │  │
│  │ 3. updateHaluka (ushar: true) × N                    │  │
│  │ 4. חישוב מי מקבל ומי נותן                            │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  שלב 3: שליחת התראות                         │
│                                                              │
│  HalukaNotificationService                                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ למקבל: "🎉 מזל טוב! קיבלת X ש״ח"                   │  │
│  │ לנותן: "📋 חלוקה אושרה - X ש״ח"                     │  │
│  │                                                       │  │
│  │ ערוצים:                                              │  │
│  │ • Socket.IO (עדכון בזמן אמת)                        │  │
│  │ • Email (מייל יפה עם svelty-email)                  │  │
│  │ • Telegram (הודעה)                                   │  │
│  │ • Push (התראה למכשיר)                                │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              שלב 4: תיאום פרטי ההעברה                        │
│                                                              │
│  /lev → didiget.svelte                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ משתמש לוחץ על "כניסה לעמוד הלב"                     │  │
│  │ ↓                                                     │  │
│  │ רואה את didiget component                            │  │
│  │ ↓                                                     │  │
│  │ לוחץ על כפתור הצ'אט                                  │  │
│  │ ↓                                                     │  │
│  │ מתאם עם המשתמש השני:                                 │  │
│  │ • איך להעביר? (העברה בנקאית/מזומן/ביט)              │  │
│  │ • מתי להעביר?                                        │  │
│  │ • פרטי חשבון בנק                                     │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  שלב 5: אישור סופי                           │
│                                                              │
│  didiget.svelte                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ נותן: לוחץ "אישור שהעברתי את הכסף"                  │  │
│  │ → updateHaluka (senderconf: true)                    │  │
│  │                                                       │  │
│  │ מקבל: לוחץ "אישור קבלת הכסף"                        │  │
│  │ → updateHaluka (confirmed: true)                     │  │
│  │                                                       │  │
│  │ אם כל ה-halukot אושרו:                               │  │
│  │ → updateUsersPermissionsUser (hervachti)             │  │
│  │ → עדכון יתרות כל המשתמשים                            │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    ✅ התהליך הושלם!
```

## דוגמה מעשית

### תרחיש: חלוקת 300 ש״ח בין 3 משתמשים

**משתתפים:**
- אליס: צריכה לקבל 150 ש״ח
- בוב: צריך לקבל 50 ש״ח
- צ'רלי: צריך לתת 200 ש״ח

**זרימה:**

1. **הצבעה** (halukaask.svelte)
   - אליס מצביעה בעד ✅
   - בוב מצביע בעד ✅
   - צ'רלי מצביע בעד ✅
   - → כולם הצביעו, עובר לאישור

2. **אישור** (/api/approveHaluka)
   - tosplit מסומן כ-finished
   - 3 halukot מסומנות כ-ushar
   - המערכת מחשבת:
     - אליס: +150 (מקבלת)
     - בוב: +50 (מקבל)
     - צ'רלי: -200 (נותן)

3. **התראות**
   - **אליס מקבלת:**
     ```
     🎉 מזל טוב! קיבלת 150 ש״ח
     החלוקה אושרה והסכום נוסף ליתרה שלך!
     כעת היכנס לעמוד הלב לתאום פרטי קבלת הכסף
     ```
   
   - **בוב מקבל:**
     ```
     🎉 מזל טוב! קיבלת 50 ש״ח
     החלוקה אושרה והסכום נוסף ליתרה שלך!
     כעת היכנס לעמוד הלב לתאום פרטי קבלת הכסף
     ```
   
   - **צ'רלי מקבל:**
     ```
     📋 חלוקה אושרה - 200 ש״ח
     החלוקה אושרה. עליך להעביר 200 ש״ח
     כעת היכנס לעמוד הלב לתאום פרטי ההעברה
     ```

4. **תיאום** (/lev → didiget)
   - צ'רלי נכנס לעמוד הלב
   - רואה 2 didiget components:
     - אחד עם אליס (150 ש״ח)
     - אחד עם בוב (50 ש״ח)
   - פותח צ'אט עם אליס, מתאם העברה בנקאית
   - פותח צ'אט עם בוב, מתאם העברה בביט

5. **אישור סופי**
   - צ'רלי מעביר 150 ש״ח לאליס → לוחץ "אישור שהעברתי"
   - אליס מקבלת → לוחצת "אישור קבלת הכסף"
   - צ'רלי מעביר 50 ש״ח לבוב → לוחץ "אישור שהעברתי"
   - בוב מקבל → לוחץ "אישור קבלת הכסף"
   - → כל ה-halukot אושרו
   - → המערכת מעדכנת את יתרות כולם

## יתרונות הזרימה

✅ **שקיפות מלאה** - כל משתמש יודע בדיוק מה הוא צריך לעשות  
✅ **תיאום קל** - צ'אט מובנה לתיאום פרטי ההעברה  
✅ **אישור דו-צדדי** - גם הנותן וגם המקבל מאשרים  
✅ **התראות בכל הערוצים** - אף אחד לא מפספס  
✅ **עדכון אוטומטי של יתרות** - רק אחרי שכולם אישרו  

## טיפים למשתמשים

### למקבלים:
1. המתן להתראה שהחלוקה אושרה
2. היכנס לעמוד הלב
3. פתח צ'אט עם הנותן
4. תאם איך לקבל את הכסף
5. אחרי שקיבלת - אשר בלחיצה על הכפתור

### לנותנים:
1. המתן להתראה שהחלוקה אושרה
2. היכנס לעמוד הלב
3. פתח צ'אט עם המקבל
4. תאם איך להעביר את הכסף
5. אחרי שהעברת - אשר בלחיצה על הכפתור
6. המתן לאישור המקבל

---

**המערכת מוכנה לשימוש! 🎉**
